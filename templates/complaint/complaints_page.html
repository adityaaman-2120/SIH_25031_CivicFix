{% extends 'base.html' %}
{% load static %}
{% block title %}Complaints & SOS - CivicFix{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/citizen.css' %}">
<style>
  .layout { display: grid; grid-template-columns: 1fr 1.2fr; gap: 1rem; }
  @media (max-width: 992px) { .layout { grid-template-columns: 1fr; } }
  #map { width: 100%; height: 480px; border-radius: .5rem; }
  .sos-btn {
    position: fixed; right: 24px; bottom: 24px; z-index: 1050;
    background: #dc3545; color: white; border: none; border-radius: 999px;
    box-shadow: 0 10px 20px rgba(220,53,69,.35); padding: 14px 22px; font-weight: 700;
  }
  .sos-btn i { margin-right: 8px; }
  .list-container { max-height: 240px; overflow: auto; }
  .badge-sos { background: #dc3545; }
  .badge-normal { background: #0d6efd; }
</style>
{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center mb-3">
  <h1 class="h3 mb-0">Report a Complaint</h1>
</div>

<div class="layout">
  <!-- Left: Complaint form and list -->
  <div>
    <div class="card mb-3">
      <div class="card-body">
        <form id="complaintForm">
          <div class="mb-3">
            <label class="form-label">Describe the issue</label>
            <textarea class="form-control" id="description" rows="4" placeholder="Pothole on the main road, water leakage, etc." required></textarea>
          </div>
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label">Latitude</label>
              <input type="number" step="any" class="form-control" id="latitude" placeholder="e.g., 28.6139" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Longitude</label>
              <input type="number" step="any" class="form-control" id="longitude" placeholder="e.g., 77.2090" required>
            </div>
          </div>
          <div class="mt-3 d-flex gap-2">
            <button type="submit" class="btn btn-primary"><i class="fa fa-paper-plane"></i> Submit Complaint</button>
            <button type="button" id="useMyLocation" class="btn btn-outline-secondary"><i class="fa fa-location-crosshairs"></i> <span class="label">Use my location</span></button>
          </div>
        </form>
      </div>
    </div>

    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>My Recent Complaints</strong>
        <button class="btn btn-sm btn-outline-primary" id="refreshList"><i class="fa fa-rotate"></i> Refresh</button>
      </div>
      <div class="card-body list-container">
        <ul id="complaintsList" class="list-group list-group-flush small"></ul>
      </div>
    </div>
  </div>

  <!-- Right: Map -->
  <div>
    <div id="map" class="border"></div>
  </div>
</div>

<!-- Floating SOS button -->
<button class="sos-btn" id="sosButton" title="Send SOS">
  <i class="fa fa-triangle-exclamation"></i> SOS
</button>
{% endblock %}

{% block extra_js %}
<script>
  // Globals
  const API_BASE = '/api/complaints/';
  let map, marker, infoWindow;

  function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
      center: { lat: 28.6139, lng: 77.2090 }, // Default center (Delhi)
      zoom: 12,
    });

    infoWindow = new google.maps.InfoWindow();

    // Create a draggable marker (hidden initially)
    marker = new google.maps.Marker({
      map,
      draggable: true,
      visible: false,
    });

    // Enable the geolocation button once map is ready
    const locBtn = document.getElementById('useMyLocation');
    if (locBtn) locBtn.disabled = false;

    // On map click: place/move marker and fill inputs
    map.addListener('click', (e) => {
      setMarker(e.latLng.lat(), e.latLng.lng());
    });

    // On marker drag: update inputs
    marker.addListener('dragend', () => {
      const pos = marker.getPosition();
      setInputs(pos.lat(), pos.lng());
    });

    // Initial fetch
    fetchComplaintsAndRender();
  }

  function setMarker(lat, lng, { show = true } = {}) {
    marker.setPosition({ lat: parseFloat(lat), lng: parseFloat(lng) });
    marker.setVisible(show);
    map.panTo(marker.getPosition());
    setInputs(lat, lng);
  }

  function setInputs(lat, lng) {
    document.getElementById('latitude').value = parseFloat(lat).toFixed(6);
    document.getElementById('longitude').value = parseFloat(lng).toFixed(6);
  }

  // Form submission -> POST /api/complaints/
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('complaintForm');
    const sosBtn = document.getElementById('sosButton');
    const useMyLocationBtn = document.getElementById('useMyLocation');
    const refreshBtn = document.getElementById('refreshList');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const description = document.getElementById('description').value.trim();
      const latitude = document.getElementById('latitude').value;
      const longitude = document.getElementById('longitude').value;
      if (!description) { alert('Please enter a description.'); return; }

      try {
        const res = await fetch(API_BASE, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken(),
          },
          body: JSON.stringify({ description, latitude, longitude })
        });
        if (!res.ok) throw new Error('Failed to submit complaint');
        const data = await res.json();
        // Place a blue marker and reset form
        addMapMarker(data, { center: true });
        form.reset();
        alert('Complaint submitted.');
        fetchComplaintsAndRender();
      } catch (err) {
        alert(err.message);
      }
    });

    useMyLocationBtn.addEventListener('click', ensureLocationPermissionThenLocate);
    refreshBtn.addEventListener('click', fetchComplaintsAndRender);

    // SOS handler -> POST /api/complaints/sos/
    sosBtn.addEventListener('click', async () => {
      if (!navigator.geolocation) { alert('Geolocation not supported.'); return; }
      navigator.geolocation.getCurrentPosition(async (pos) => {
        const { latitude, longitude } = pos.coords;
        try {
          const res = await fetch(API_BASE + 'sos/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCsrfToken(),
            },
            body: JSON.stringify({ latitude, longitude, description: '⚠️ Emergency! I am in danger, please send help!' })
          });
          if (!res.ok) throw new Error('Failed to send SOS');
          const data = await res.json();
          addMapMarker(data, { center: true });
          alert('SOS sent successfully.');
          fetchComplaintsAndRender();
        } catch (err) { alert(err.message); }
      }, (err) => alert('Geolocation error: ' + err.message));
    });
  });

  async function ensureLocationPermissionThenLocate() {
    const btn = document.getElementById('useMyLocation');
    if (!navigator.geolocation) { alert('Geolocation not supported by your browser.'); return; }

    try {
      if (navigator.permissions && navigator.permissions.query) {
        const status = await navigator.permissions.query({ name: 'geolocation' });
        if (status.state === 'denied') {
          showLocationHelpModal();
          return;
        }
        // If 'granted' or 'prompt', proceed to request location (will prompt if needed)
      }
    } catch (_) {
      // Permissions API not supported – fall through to request
    }

    geoFillInputs();
  }

  function geoFillInputs() {
    const btn = document.getElementById('useMyLocation');
    if (btn) { btn.disabled = true; btn.querySelector('.label').textContent = 'Locating…'; }
    navigator.geolocation.getCurrentPosition((pos) => {
      const { latitude, longitude } = pos.coords;
      if (map && marker) {
        setMarker(latitude, longitude);
        map.setZoom(16); // zoom closer to current position
      } else {
        // Map not ready yet; just fill inputs. initMap will pick these up.
        setInputs(latitude, longitude);
      }
      if (btn) { btn.disabled = false; btn.querySelector('.label').textContent = 'Use my location'; }
    }, (err) => {
      if (err.code === 1) {
        // Permission denied – show help modal
        showLocationHelpModal();
      } else {
        const msg = {
          2: 'Position unavailable. Try again.',
          3: 'Request timed out. Try again.',
        }[err.code] || ('Geolocation error: ' + err.message);
        alert(msg);
      }
      if (btn) { btn.disabled = false; btn.querySelector('.label').textContent = 'Use my location'; }
    }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
  }

  function showLocationHelpModal() {
    const html = `
      <div class="modal fade" id="locHelpModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content shadow-lg border-0 text-dark">
            <div class="modal-header border-0 pb-0">
              <div class="d-flex align-items-center gap-2">
                <div class="rounded-circle d-inline-flex align-items-center justify-content-center" style="width:40px;height:40px;background:#eaf4ff;">
                  <i class="fa fa-location-dot text-primary"></i>
                </div>
                <div>
                  <h5 class="modal-title mb-0 fw-semibold">Allow Location Access</h5>
                  <small class="text-muted">We need your location to pin it on the map.</small>
                </div>
              </div>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body pt-3">
              <ol class="mb-3 ps-3">
                <li class="mb-1">Click the lock icon in the address bar.</li>
                <li class="mb-1">Open “Permissions” or “Site settings”.</li>
                <li class="mb-1">Set “Location” to “Allow”, then try again.</li>
              </ol>
              <div class="small text-muted">Tip: Geolocation works best on HTTPS or localhost.</div>
            </div>
            <div class="modal-footer border-0 pt-0">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" id="retryGeolocate">
                <i class="fa fa-location-crosshairs me-1"></i> Allow location now
              </button>
            </div>
          </div>
        </div>
      </div>`;
    let modalEl = document.getElementById('locHelpModal');
    if (!modalEl) {
      const div = document.createElement('div');
      div.innerHTML = html;
      document.body.appendChild(div.firstElementChild);
      modalEl = document.getElementById('locHelpModal');
    }
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
    modalEl.querySelector('#retryGeolocate').onclick = () => {
      modal.hide();
      geoFillInputs();
    };
  }

  async function fetchComplaintsAndRender() {
    try {
      const res = await fetch(API_BASE, { headers: { 'Accept': 'application/json' } });
      if (!res.ok) throw new Error('Failed to load complaints');
      const data = await res.json();
      renderList(data);
      renderMarkers(data);
    } catch (e) { console.warn(e); }
  }

  function renderList(items) {
    const list = document.getElementById('complaintsList');
    list.innerHTML = '';
    if (!Array.isArray(items) || !items.length) {
      list.innerHTML = '<li class="list-group-item">No complaints yet.</li>';
      return;
    }
    items.forEach(item => {
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex justify-content-between align-items-center';
      const badgeClass = item.is_sos ? 'badge-sos' : 'badge-normal';
      li.innerHTML = `
        <span>
          <strong>#${item.id}</strong> — ${escapeHtml(item.description)}
          <small class="text-muted">(${parseFloat(item.latitude).toFixed(4)}, ${parseFloat(item.longitude).toFixed(4)})</small>
        </span>
        <span class="badge ${badgeClass}">${item.is_sos ? 'SOS' : 'Complaint'}</span>
      `;
      li.addEventListener('click', () => {
        setMarker(item.latitude, item.longitude);
        infoWindow.setContent(`#${item.id} ${escapeHtml(item.description)}`);
        infoWindow.open({ anchor: marker, map });
      });
      list.appendChild(li);
    });
  }

  function renderMarkers(items) {
    // Clear existing temporary marker visibility
    marker.setVisible(false);
    items.forEach(addMapMarker);
  }

  function addMapMarker(item, options = {}) {
    const color = item.is_sos ? 'red' : 'blue';
    const pin = new google.maps.marker.PinElement({
      background: color,
      borderColor: color,
      glyphColor: 'white'
    });
    const m = new google.maps.marker.AdvancedMarkerElement({
      map,
      position: { lat: parseFloat(item.latitude), lng: parseFloat(item.longitude) },
      content: pin.element
    });
    m.addListener('click', () => {
      const content = `#${item.id} ${escapeHtml(item.description)}`;
      new google.maps.InfoWindow({ content }).open({ anchor: m, map });
    });
    if (options.center) map.panTo(m.position);
  }

  function escapeHtml(s) {
    // Escape minimal HTML to avoid XSS in InfoWindow/list
    return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c] || c));
  }

  function getCsrfToken() {
    const name = 'csrftoken=';
    const cookies = document.cookie.split(';');
    for (const c of cookies) {
      const x = c.trim();
      if (x.startsWith(name)) return x.substring(name.length, x.length);
    }
    // Fallback: look for csrftoken input if present
    const meta = document.querySelector('input[name=csrfmiddlewaretoken]');
    return meta ? meta.value : '';
  }
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initMap&libraries=marker"></script>
{% endblock %}